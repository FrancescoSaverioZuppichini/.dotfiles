{"version":3,"file":"index.cjs.js","sources":["../../../dist/loaders/url/src/index.js"],"sourcesContent":["import { __awaiter } from \"tslib\";\n/* eslint-disable no-case-declarations */\nimport { print, Kind } from 'graphql';\nimport { observableToAsyncIterable, } from '@graphql-tools/utils';\nimport { isWebUri } from 'valid-url';\nimport { fetch as crossFetch } from 'cross-fetch';\nimport { introspectSchema, wrapSchema } from '@graphql-tools/wrap';\nimport { SubscriptionClient } from 'subscriptions-transport-ws';\nimport { w3cwebsocket } from 'websocket';\n/**\n * This loader loads a schema from a URL. The loaded schema is a fully-executable,\n * remote schema since it's created using [@graphql-tools/wrap](/docs/remote-schemas).\n *\n * ```\n * const schema = await loadSchema('http://localhost:3000/graphql', {\n *   loaders: [\n *     new UrlLoader(),\n *   ]\n * });\n * ```\n */\nexport class UrlLoader {\n    loaderId() {\n        return 'url';\n    }\n    canLoad(pointer, options) {\n        return __awaiter(this, void 0, void 0, function* () {\n            return this.canLoadSync(pointer, options);\n        });\n    }\n    canLoadSync(pointer, _options) {\n        return !!isWebUri(pointer);\n    }\n    buildAsyncExecutor({ pointer, fetch, extraHeaders, defaultMethod, useGETForQueries, }) {\n        const HTTP_URL = pointer.replace('ws:', 'http:').replace('wss:', 'https:');\n        return ({ document, variables }) => __awaiter(this, void 0, void 0, function* () {\n            let method = defaultMethod;\n            if (useGETForQueries) {\n                method = 'GET';\n                for (const definition of document.definitions) {\n                    if (definition.kind === Kind.OPERATION_DEFINITION) {\n                        if (definition.operation !== 'query') {\n                            method = defaultMethod;\n                        }\n                    }\n                }\n            }\n            let fetchResult;\n            const query = print(document);\n            switch (method) {\n                case 'GET':\n                    const urlObj = new URL(HTTP_URL);\n                    urlObj.searchParams.set('query', query);\n                    if (variables && Object.keys(variables).length > 0) {\n                        urlObj.searchParams.set('variables', JSON.stringify(variables));\n                    }\n                    const finalUrl = urlObj.toString();\n                    fetchResult = yield fetch(finalUrl, {\n                        method: 'GET',\n                        headers: extraHeaders,\n                    });\n                    break;\n                case 'POST':\n                    fetchResult = yield fetch(HTTP_URL, {\n                        method: 'POST',\n                        body: JSON.stringify({\n                            query,\n                            variables,\n                        }),\n                        headers: extraHeaders,\n                    });\n                    break;\n            }\n            return fetchResult.json();\n        });\n    }\n    buildSubscriber(pointer, webSocketImpl) {\n        const WS_URL = pointer.replace('http:', 'ws:').replace('https:', 'wss:');\n        const subscriptionClient = new SubscriptionClient(WS_URL, {}, webSocketImpl);\n        return ({ document, variables }) => __awaiter(this, void 0, void 0, function* () {\n            return observableToAsyncIterable(subscriptionClient.request({\n                query: document,\n                variables,\n            }));\n        });\n    }\n    getExecutorAndSubscriber(pointer, options) {\n        return __awaiter(this, void 0, void 0, function* () {\n            let headers = {};\n            let fetch = crossFetch;\n            let defaultMethod = 'POST';\n            let webSocketImpl = w3cwebsocket;\n            if (options) {\n                if (Array.isArray(options.headers)) {\n                    headers = options.headers.reduce((prev, v) => (Object.assign(Object.assign({}, prev), v)), {});\n                }\n                else if (typeof options.headers === 'object') {\n                    headers = options.headers;\n                }\n                if (options.customFetch) {\n                    if (typeof options.customFetch === 'string') {\n                        const [moduleName, fetchFnName] = options.customFetch.split('#');\n                        fetch = yield import(moduleName).then(module => (fetchFnName ? module[fetchFnName] : module));\n                    }\n                    else {\n                        fetch = options.customFetch;\n                    }\n                }\n                if (options.webSocketImpl) {\n                    if (typeof options.webSocketImpl === 'string') {\n                        const [moduleName, webSocketImplName] = options.webSocketImpl.split('#');\n                        webSocketImpl = yield import(moduleName).then(module => webSocketImplName ? module[webSocketImplName] : module);\n                    }\n                    else {\n                        webSocketImpl = options.webSocketImpl;\n                    }\n                }\n                if (options.method) {\n                    defaultMethod = options.method;\n                }\n            }\n            const extraHeaders = Object.assign({ Accept: 'application/json', 'Content-Type': 'application/json' }, headers);\n            const executor = this.buildAsyncExecutor({\n                pointer,\n                fetch,\n                extraHeaders,\n                defaultMethod,\n                useGETForQueries: options.useGETForQueries,\n            });\n            let subscriber;\n            if (options.enableSubscriptions) {\n                subscriber = this.buildSubscriber(pointer, webSocketImpl);\n            }\n            return {\n                executor,\n                subscriber,\n            };\n        });\n    }\n    getSubschemaConfig(pointer, options) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const { executor, subscriber } = yield this.getExecutorAndSubscriber(pointer, options);\n            return {\n                schema: yield introspectSchema(executor, undefined, options),\n                executor,\n                subscriber,\n            };\n        });\n    }\n    load(pointer, options) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const subschemaConfig = yield this.getSubschemaConfig(pointer, options);\n            const remoteExecutableSchema = wrapSchema(subschemaConfig);\n            return {\n                location: pointer,\n                schema: remoteExecutableSchema,\n            };\n        });\n    }\n    loadSync() {\n        throw new Error('Loader Url has no sync mode');\n    }\n}\n//# sourceMappingURL=index.js.map"],"names":["__awaiter","isWebUri","Kind","print","SubscriptionClient","observableToAsyncIterable","crossFetch","w3cwebsocket","introspectSchema","wrapSchema"],"mappings":"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"}