!function(e,t){for(var n in t)e[n]=t[n]}(exports,function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=1156)}({11:function(e,t){e.exports=require("fs")},1156:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(48),i=n(80),s=n(11),o=n(16),c=n(8),u=n(27),a=JSON.parse(process.argv[2]);let l=!1;function p(e,t,n,r){t.writeHead(n,{"Content-Type":"text/plain"}),t.end(r)}function d(e){console.log(u.markLines(e,"local-server"))}function f(e){console.error(u.markLines(e,"local-server"))}class h{constructor(){this.child=h.spawnSsh()}dispose(){this.child.kill()}static spawnSsh(){const e=r.spawn(a.sshCommand,a.sshArgs,{stdio:["inherit","pipe","pipe"],windowsHide:!0});let t=!1;return e.stdout.on("data",e=>{t||process.stdout.write(e),e.toString().includes(": end")&&(t=!0)}),e.stderr.on("data",e=>{t||process.stderr.write(e)}),e.on("exit",()=>{l||(d("ssh child died, shutting down"),process.exit(0))}),d("Spawned ssh: "+e.pid),e}}const g=new class{constructor(e){this.ipcHandlePath=e,this.server=o.createServer((e,t)=>this.onRequest(e,t));try{this.server.listen(this.ipcHandlePath),this.server.on("error",e=>f(e.message))}catch(e){f("Could not launch management server."),process.exit(1)}this.delayShutdown()}delayShutdown(){this.shutdownTimer&&clearTimeout(this.shutdownTimer),this.shutdownTimer=setTimeout(()=>{this.dispose(),S(),d("Timed out"),process.exit(0)},5e3)}onRequest(e,t){if("GET"!==e.method)return t.writeHead(405,{"Content-Type":"text/plain"}),t.end("Unsupported method "+e.method);if(!e.url)return p(0,t,400,"Bad request.");const n=c.parse(e.url,!0).pathname;return n?("/delay-shutdown"===n&&(this.delayShutdown(),t.writeHead(200),t.end("OK")),t.writeHead(404,{"Content-Type":"text/plain"}),t.end("Not found")):p(0,t,400,"Bad request.")}dispose(){this.server.close()}}(a.ipcHandlePath),m=new h;function S(){if(l=!0,g.dispose(),m.dispose(),a.dataFilePath&&s.existsSync(a.dataFilePath))try{const e=s.readFileSync(a.dataFilePath);JSON.parse(e.toString()).pid===process.pid&&s.unlinkSync(a.dataFilePath)}catch(e){}}process.on("exit",()=>{S()}),process.on("SIGTERM",()=>{S(),process.exit(i.SIGTERM)})},16:function(e,t){e.exports=require("http")},27:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseStringMap=t.stripAllNewlines=t.escapeRegExpCharacters=t.splitLines=t.markLine=t.markLines=t.sanitizeConnectionToken=t.sanitizeInstallScriptOutput=t.stripTrailingNewline=t.quoteForShellIfNeeded=t.quoteForShell=t.stripEscapeSequences=t.lastNonemptyLine=void 0;const r=n(31);function i(e){return e.replace(/\x1b\[\??[0-9]{0,3}(;[0-9]{1,3})?[a-zA-Z]/g,"").replace(/\u0008/g,"").replace(/\r/g,"")}function s(e,t){return t?`"${e}"`:`'${e}'`}function o(e){return e.replace(/\r?\n$/,"")}function c(e){return e.replace(/[a-z]/g,"a").replace(/[A-Z]/g,"A").replace(/[0-9]/g,"1")}function u(e){return e.split(/\r?\n/g)}t.lastNonemptyLine=function(e){const t=u(e);if(r.isWindows)for(let e=t.length-1;e>=0;e--){const n=i(t[e]);if(n)return n}const n=t.filter(e=>!!e);return n[n.length-1]},t.stripEscapeSequences=i,t.quoteForShell=s,t.quoteForShellIfNeeded=function(e,t){return e.match(/[^a-z0-9]/)?s(e,t):e},t.stripTrailingNewline=o,t.sanitizeInstallScriptOutput=function(e){return function(e){return e.replace(/connectionToken==(.*)==/,(e,t)=>`connectionToken==${c(t)}==`)}(e)},t.sanitizeConnectionToken=c,t.markLines=function(e,t=""){return u(o(e)).map(e=>`${t}> ${e}`).join("\n")},t.markLine=function(e,t=""){return`${t}> ${e}`},t.splitLines=u,t.escapeRegExpCharacters=function(e){return e.replace(/[\\\{\}\*\+\?\|\^\$\.\[\]\(\)]/g,"\\$&")},t.stripAllNewlines=function(e){return e.replace(/\r?\n/,"")},t.parseStringMap=function(e,t="==",n){e=e.trim().replace(/\r?\n/g,"");const r={};for(let i=0;i<e.length;){const s=e.indexOf(t,i),o=e.indexOf(t,s+t.length);if(-1===s||-1===o)return n.debug("Stopped parsing output early. Remaining text: "+e.substring(i)),r;const c=e.slice(s+t.length,o);r[e.slice(i,s)]=c,i=o+t.length;const u=e.substr(i).match(/^\s+/);u&&u[0]&&(i+=u[0].length)}return r}},31:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isWindows=void 0,t.isWindows="win32"===process.platform},48:function(e,t){e.exports=require("child_process")},8:function(e,t){e.exports=require("url")},80:function(e,t){e.exports=require("constants")}}));
//# sourceMappingURL=localServer.js.map